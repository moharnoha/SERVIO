<!DOCTYPE html>
<html lang="ar" dir="rtl" class="notranslate" translate="no"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Servio - Order Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary-green: #2E5822; 
            --sub-green: #386E2C;
            --bg-gray: #f4f7f5;
            --card-white: #ffffff;
            --text-main: #1A2419;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --error-red: #C62828;
            --input-focus: #2E5822;
            --shadow: 0 10px 30px rgba(46, 88, 34, 0.06);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-gray); display: flex; justify-content: center; color: var(--text-main); }
        .container-wrapper { width: 100%; display: flex; justify-content: center; }
        .main-container { width: 100%; max-width: 500px; min-height: 100vh; display: flex; flex-direction: column; }

        .content-area { padding: 25px 20px; flex: 1; }
        .order-card { 
            width: 100%; background: var(--card-white); border-radius: 30px; 
            border: 1px solid rgba(255,255,255,0.8); box-shadow: var(--shadow); 
            padding: 28px; box-sizing: border-box; 
        }

        .order-header { display: flex; align-items: center; gap: 14px; margin-bottom: 30px; }
        .order-icon-circle { 
            width: 50px; height: 50px; background: #EAF0E9; 
            border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--primary-green); 
        }
        .order-icon-circle svg { width: 24px; height: 24px; fill: currentColor; }
        .order-title { font-size: 19px; font-weight: 800; color: var(--text-main); }

        .form-grid { display: flex; flex-direction: column; gap: 20px; }
        .field .label { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; display: block; padding-right: 4px; }
        
        .input-box { 
            display: flex; align-items: center; background: #f9fbf9; 
            border: 1.5px solid #edf2ed; border-radius: 16px; padding: 0 16px; 
            height: 56px; transition: all 0.25s ease; 
        }
        .input-box:focus-within { 
            border-color: var(--input-focus); background: #ffffff; 
            box-shadow: 0 0 0 4px rgba(46, 88, 34, 0.05); 
        }
        .input-box svg { width: 20px; height: 20px; fill: #94a3b8; flex-shrink: 0; }
        
        [dir="rtl"] .input-box svg { margin-left: 12px; }
        .input-box input, .input-box span { 
            flex: 1; border: none; outline: none; background: none; 
            font-size: 14px; font-weight: 600; color: var(--text-main); width: 100%; 
        }
        
        .input-readonly { background: #f1f5f9 !important; cursor: not-allowed; color: #64748b !important; }

        .limit-hint { font-size: 10px; color: #94a3b8; margin-top: 8px; font-weight: 700; display: flex; gap: 10px; padding-right: 5px; }
        .limit-error { color: var(--error-red) !important; font-weight: 800; }

        .price-container { 
            background: linear-gradient(135deg, #2E5822 0%, #1a3314 100%); 
            border-radius: 20px; padding: 20px; display: flex; justify-content: space-between; 
            align-items: center; margin-top: 10px; box-shadow: 0 10px 20px rgba(46, 88, 34, 0.2);
        }
        .price-label { font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.8); }
        .price-value { font-size: 20px; font-weight: 800; color: #ffffff; font-variant-numeric: tabular-nums; }

        #payBtn { 
            width: 100%; height: 60px; border: none; border-radius: 18px; 
            background: var(--text-main); color: #ffffff; font-size: 16px; 
            font-weight: 700; cursor: pointer; position: relative; 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.3s; margin-top: 10px;
        }
        #payBtn:active { transform: scale(0.98); }
        #payBtn:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.6; }

        .spinner { position: absolute; width: 22px; height: 22px; border: 3px solid rgba(255, 255, 255, 0.2); border-top-color: #fff; border-radius: 50%; opacity: 0; }
        .loading .spinner { opacity: 1; animation: spin 0.8s linear infinite; }
        .loading #btn-text { opacity: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <div class="main-container">
            <div class="content-area">
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-icon-circle"><svg viewBox="0 0 24 24"><path d="M17,18C15.89,18 15,18.89 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20C19,18.89 18.1,18 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.48C21.04,5.19 21.13,4.86 21.13,4.52A1,1 0 0,0 20.13,3.52H5.21L4.27,1.52M7,18C5.89,18 5,18.89 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20C9,18.89 8.1,18 7,18Z"/></svg></div>
                        <div class="order-title">مراجعة الطلب</div>
                    </div>

                    <div class="form-grid">
                        <div class="field">
                            <label class="label">رابط الهدف</label>
                            <div class="input-box">
                                <svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                                <input id="platformLink" placeholder="أدخل الرابط هنا...">
                            </div>
                        </div>

                        <div class="field" onclick="goToCategory()">
                            <label class="label">نوع الخدمة</label>
                            <div class="input-box" style="cursor:pointer; background: #f1f5f1; border-style: dashed;">
                                <svg viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
                                <span id="category" style="color:var(--primary-green)">اختر الخدمة...</span>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">الكمية المطلوبة</label>
                            <div class="input-box" id="qty-box">
                                <svg viewBox="0 0 24 24"><path d="M11 13H13V17H11V13M11 7H13V11H11V7M1 21H23V19H1V21M3 3V17H21V3H3M5 5H19V15H5V5Z"/></svg>
                                <input id="quantity" type="text" inputmode="numeric" placeholder="0">
                            </div>
                            <div class="limit-hint">
                                <span id="min-hint">الأدنى: --</span>
                                <span id="max-hint">الأقصى: --</span>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">البريد الإلكتروني للحساب</label>
                            <div class="input-box input-readonly">
                                <svg viewBox="0 0 24 24"><path d="M22,6C22,4.9 21.1,4 20,4H4C2.9,4 2,4.9 2,6V18C2,19.1 2.9,20 4,20H20C21.1,20 22,19.1 22,18V6M20,6L12,11L4,6H20M20,18H4V8L12,13L20,8V18Z"/></svg>
                                <input id="email" type="email" readonly placeholder="جاري التحميل..." style="direction: ltr; text-align: right;">
                            </div>
                        </div>

                        <div class="price-container">
                            <span class="price-label">المبلغ الإجمالي</span>
                            <span class="price-value" id="display-price">0.00$</span>
                        </div>

                        <button id="payBtn" disabled>
                            <span id="btn-text">تأكيد الدفع والطلب</span>
                            <div class="spinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbxJ0oupWVWSzpDrnEELES_4xlX-wWB05dgr7SFuww9JmjfFJkRj-nCrqWCUnmkSgABI/exec";

        function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

        function validateAndPrice() {
            const qtyInput = document.getElementById("quantity");
            const payBtn = document.getElementById("payBtn");
            const minHint = document.getElementById("min-hint");
            const maxHint = document.getElementById("max-hint");
            const qtyBox = document.getElementById("qty-box");

            // جلب البيانات المخزنة من صفحة الفئات
            const minQty = parseInt(localStorage.getItem("service_min")) || 0;
            const maxQty = parseInt(localStorage.getItem("service_max")) || Infinity;
            const unitPrice = parseFloat(localStorage.getItem("service_price")) || 0;

            let rawValue = qtyInput.value.replace(/[^0-9]/g, '');
            let currentQty = parseInt(rawValue) || 0;

            // حساب السعر
            const total = unitPrice * currentQty;
            document.getElementById("display-price").innerText = `${total.toFixed(5)}$`;

            // التحقق من الحدود
            let isValid = true;
            if (currentQty < minQty || currentQty > maxQty || currentQty === 0) {
                isValid = false;
                if (currentQty > 0) {
                    if (currentQty < minQty) minHint.classList.add("limit-error");
                    else minHint.classList.remove("limit-error");
                    
                    if (currentQty > maxQty) maxHint.classList.add("limit-error");
                    else maxHint.classList.remove("limit-error");
                    
                    qtyBox.style.borderColor = "var(--error-red)";
                }
            } else {
                minHint.classList.remove("limit-error");
                maxHint.classList.remove("limit-error");
                qtyBox.style.borderColor = "var(--primary-green)";
            }

            payBtn.disabled = !isValid;
            if (rawValue !== "") { qtyInput.value = formatNumber(rawValue); }
        }

        function updateUI() {
            const min = localStorage.getItem("service_min") || "--";
            const max = localStorage.getItem("service_max") || "--";
            
            document.getElementById('min-hint').innerText = "الأدنى: " + formatNumber(min);
            document.getElementById('max-hint').innerText = "الأقصى: " + formatNumber(max);
            document.getElementById("category").innerText = localStorage.getItem('chosen_service') || "اضغط لاختيار الخدمة";
            document.getElementById("platformLink").value = localStorage.getItem("temp_link") || "";
            
            validateAndPrice();
        }

        function goToCategory() {
            localStorage.setItem("temp_link", document.getElementById("platformLink").value);
            location.href = `../Category/`;
        }

        window.onload = updateUI;
        document.getElementById("quantity").oninput = validateAndPrice;
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBYNRiMneaU-d6FPMbCnjcWQBX4Tdg50zk", 
            authDomain: "serviocmm-a65ed.firebaseapp.com", 
            projectId: "serviocmm-a65ed", 
            appId: "1:975373759034:web:645cb5fb48772839453b03" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => { 
            if (user) { document.getElementById("email").value = user.email; }
            else { window.location.href = "../login/"; }
        });

        document.getElementById("payBtn").onclick = async function() {
            const user = auth.currentUser;
            if (!user) return;

            const link = document.getElementById("platformLink").value;
            const email = document.getElementById("email").value;
            const qtyRaw = document.getElementById("quantity").value.replace(/,/g, '');
            const qtyNum = parseInt(qtyRaw) || 0;
            const unitPrice = parseFloat(localStorage.getItem("service_price")) || 0;
            const finalCharge = unitPrice * qtyNum;
            const service = localStorage.getItem("chosen_service");

            if (!link || !service || qtyNum <= 0) return;

            this.classList.add('loading');
            this.disabled = true;

            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists() && (userSnap.data().balance || 0) >= finalCharge) {
                    await updateDoc(userRef, {
                        balance: increment(-finalCharge),
                        total_spend: increment(finalCharge)
                    });

                    await addDoc(collection(db, "transactions"), {
                        amount: `-${finalCharge.toFixed(7)}`,
                        description: "شراء: " + service,
                        timestamp: serverTimestamp(),
                        userId: user.uid,
                        userEmail: email
                    });

                    await fetch(scriptURL, { 
                        method: "POST", mode: "no-cors", 
                        body: JSON.stringify({ platformLink: link, category: service, quantity: qtyNum, charge: finalCharge.toFixed(7), gmail: email }) 
                    });

                    location.href = `Confirm/?link=${encodeURIComponent(link)}`;
                } else {
                    alert("رصيدك غير كافٍ");
                    this.classList.remove('loading');
                    this.disabled = false;
                }
            } catch (e) {
                alert("خطأ في العملية");
                this.classList.remove('loading');
                this.disabled = false;
            }
        };
    </script>
</body>
</html>
